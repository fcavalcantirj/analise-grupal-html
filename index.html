<!doctype html>
<html class="no-js" lang="pt">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analise Grupal</title>
  <link rel="stylesheet" href="css/style.css">
  <meta name="description" content="Descubra mais sobre o Analise Grupal, um projeto open-source para an√°lise de chats do WhatsApp que assegura total privacidade e n√£o armazena dados.">

  <meta property="og:title" content="Sobre o Analise Grupal">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://www.analisegrupal.com.br">
  <meta property="og:image" content="https://analisegrupal.com.br/img/analise_grupal_logo.png">

  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" href="/icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="icon.png">

  <link rel="manifest" href="site.webmanifest">
  <meta name="theme-color" content="#fafafa">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            background-color: #72684F;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;

            font-family: 'Roboto', sans-serif; /* New font */
/*            background: #f4f4f4; /* Lighter background */*/
            color: #333; /* Dark grey text for better readability */
        }

        h1 {
              color: #333;
              margin-bottom: 2rem;
              font-size: 2rem;
        }

        form {
            background-color: #FFF;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 480px;

            border: 1px solid #e0e0e0; /* Light border */
        }

        img {
            max-width: 100%; /* ensures images are responsive and don't overflow their container */
            height: auto;
        }

        #analysisResults {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #analysisResults > * {
            margin: 20px 0;
        }

      label {
          display: block;
          margin-bottom: 1rem;
          color: #555;
          font-weight: bold;
      }

      span {
          display: block;
          margin-bottom: 1rem;
          color: #555;
      }

      input[type="file"] {
          margin-bottom: 1.5rem;
          padding: 0.5rem;
          border: 1px solid #AAA;
          border-radius: 4px;
      }

      input[type="submit"] {
/*          background-color: #4CAF50;*/
          color: #FFF;
          padding: 0.5rem 1rem;
          border: none;
          border-radius: 4px;
          cursor: pointer;
/*          transition: background-color 0.3s ease;*/

          background-color: #008cba; /* More modern button color */
          transition: background-color 0.3s ease, transform 0.3s ease; /* Smooth transitions */
      }

      input[type="submit"]:hover {
/*          background-color: #45a049;*/

          background-color: #005f6b; /* Darker shade on hover */
          transform: translateY(-2px); /* Slight lift effect */
      }

      iframe {
          width: 100%;
          margin: 0;
          padding: 0;
          border: none;
      }

    /* Add media queries for responsiveness */
    @media (max-width: 768px) {
      form {
        width: 90%; /* Full width on smaller screens */
        margin: 0 auto; /* Center form */
      }
    }

    footer {
        margin-top: 2rem;
        text-align: center;
        width: 100%;
        margin-bottom: 1rem;
    }

    footer p {
        color: #aaa;
    }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-7DTBLS7LPL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // Your Google Analytics ID
      gtag('config', 'G-7DTBLS7LPL');

      // Your Google Ads ID, for conversion tracking
      gtag('config', 'AW-11398970229');

      function trackEvent(action, category, label, value) {
          gtag('event', action, {
              'event_category': category,
              'event_label': label,
              'value': value
          });
      }
    </script>
</head>

<body>

  <!-- <h1>An√°lise Grupal BETA</h1> -->
  <img src="img/analise_grupal_logo.png">

  <form id="uploadForm" enctype="multipart/form-data" onsubmit="return submitForm();">
      <span>Clique <a href="https://tecnoblog.net/responde/whatsapp-salvar-historico-conversa/" target="_blank">aqui</a> para aprender a exportar o chat</span>
      <label for="file">Fa√ßa upload de um chat do whatsApp:</label>
      <input type="file" name="file" required id="file">
      <input type="submit" value="Carregar e Analisar">
      <span style="margin-top: 2rem;">obs: <b>nenhum</b> dado √© armazenado!!!</span>
      <span>N√£o entendi nada!!! Clique <a href="about.html" onclick="trackEvent('about', 'AnaliseGrupal', 'about_clicked', 1);">aqui</a></span>
  </form>

  <div id="analysisResults"></div>


  <script src="js/app.js"></script>
  <script>
      const endpoints = [
          '/whatsapp/message/avg_sentiment_per_person',
          '/whatsapp/message/sentiment_over_time',
          '/whatsapp/message/peak_response_time',
          '/whatsapp/message/activity_heatmap',
          '/whatsapp/message/user_activity_over_time',
          '/whatsapp/message/conversational_turns',
          '/whatsapp/message/active_days',
          '/whatsapp/message/topic_percentage',
          '/whatsapp/message/wordfrequency/25',
          '/whatsapp/message/wordcloud',
          '/whatsapp/message/lenghiest/top/10',
          '/whatsapp/message/sentiment/distribution',
          '/whatsapp/message/heatmap',
          '/whatsapp/message/usercount',
          // '/whatsapp/message/activeusers/10', redundant
          // '/whatsapp/message/topic_modeling' // not working
      ];

      const endpointTitles = {
          'message/avg_sentiment_per_person': 'Acima de 0 - palavras positivas | abaixo de 0 - negativas',
          'message/sentiment_over_time': 'Sentimento ao Longo do Tempo',
          'message/peak_response_time': 'Picos de mensagens por Usu√°rio por hora',
          'message/activity_heatmap': 'N√∫mero de mensagems X Hora do dia',
          'message/user_activity_over_time': 'Atividade dos Usu√°rios ao Longo do Tempo',
          'message/conversational_turns': 'Quem mais "puxa novos papos" e/ou "responde menos"',
          'message/active_days': 'N√∫mero de mensagens por dia da semana',
          'message/topic_percentage': 'Percentual de T√≥picos',
          'wordfrequency/25': 'Frequ√™ncia de Palavras que mais aparecem (Top 25)',
          'message/wordcloud': 'Nuvem de Palavras | WordCloud',
          'top/10': '10 usu√°rios que mandam as maiores mensagens',
          'sentiment/distribution': 'M√©dia de sentimento (LeIA/Vader sentiment analysis)',
          'message/heatmap': 'Mapa de calor | Mensagens enviadas por hora',
          'message/usercount': 'TOP 20 que mais enviam | BOTTOM 5 que menos enviam',
          'activeusers/10': 'TOP 10 Usu√°rios que mais enviam mensagens',
          // 'topic_modeling': 'Modelagem de T√≥picos' // n√£o est√° funcionando
      };

      const MAX_RETRIES = 3;
      const API_DOMAIN = 'https://api.analisegrupal.com.br'
      // const API_DOMAIN = 'http://localhost:5000'

      function shareOnWhatsApp(imageUrl, customMessage) {
          const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
          const encodedImageUrl = encodeURIComponent('----> ' + imageUrl);
          const encodedMessage = encodeURIComponent(customMessage);
          const whatsappUrl = isMobile ? `whatsapp://send?text=${encodedMessage}%20${encodedImageUrl}`
                                       : `https://web.whatsapp.com/send?text=${encodedMessage}%20${encodedImageUrl}`;
          trackEvent('share', 'WhatsApp', 'Content Share', 1);
          // window.open(whatsappUrl, '_blank');
          window.open(whatsappUrl);
      }

      function uploadToImgur(index) {
        trackEvent('share', 'WhatsApp', 'Content Share Try', 1);
        gtag('share', 'WhatsApp', {'send_to': 'AW-11398970229/w499CJ7ZufMYEPX2ubsq'});
        // Show the spinner when the upload starts
        // spinner.style.display = 'inline-block';
        const _tempId = 'image' + index;
        const _spinnerId = 'spinner' + index;
          const imgElement = document.getElementById(_tempId);
          const spinnerElemment = document.getElementById(_spinnerId);
          spinnerElemment.style.display = 'inline-block';
          fetch(imgElement.src)
          .then(res => res.blob())
          .then(blob => {
              validateImage(blob).then(validBlob => {
                  let formData = new FormData();
                  formData.append('image', validBlob);

                  fetch(API_DOMAIN + '/upload_to_imgur', {
                      method: 'POST',
                      body: formData
                  })
                  .then(response => response.json())
                  .then(data => {
                    spinnerElemment.style.display = 'none';
                    if (data.link) {
                        shareOnWhatsApp(data.link, 'üöÄ Descubra as estat√≠sticas do nosso grupo do WhatsApp com esta an√°lise! üìäüßê Confira no https://analisegrupal.com.br/ #An√°liseGrupal');
                    } else {
                      // console.log(data)
                      const error = data.response.data.error
                      if(error) {
                        alert(error)
                      }
                      throw new Error('Imgur upload failed or no link returned.');
                    }
                  })
                  .catch(error => {
                      spinnerElemment.style.display = 'none';
                      console.error('Error uploading to Imgur or sharing on WhatsApp:', error);
                  });
              }).catch(error => {
                  spinnerElemment.style.display = 'none';
                  console.error('Invalid image for upload:', error);
              });
          });
      }

      function validateImage(blob) {
          return new Promise((resolve, reject) => {
              const imageUrl = URL.createObjectURL(blob);
              const img = new Image();
              img.onload = () => resolve(blob);  // If loading succeeds, the image is valid
              img.onerror = () => reject(new Error('Invalid image'));  // If there's an error, the image isn't valid
              img.src = imageUrl;
          });
      }

      function fetchData(endpoint, formData, retries = 0) {
            return fetch(API_DOMAIN + endpoint, {
          // return fetch('http://localhost:5000' + endpoint, {
              method: 'POST',
              body: formData
          })
          .then(response => {
              if (!response.ok && retries < MAX_RETRIES) {
                  return fetchData(endpoint, formData, retries + 1);
              } else if (!response.ok) {
                  throw new Error(`Failed after ${MAX_RETRIES} retries.`);
              }
              if(endpoint === '/whatsapp/message/topic_modeling') {
                  return response.text()
              } else {
                  return response.blob()
              }
          });
      }

      function processEndpoint(index, formData) {
          if (index >= endpoints.length) {
              return;  // All endpoints processed
          }

          const endpoint = endpoints[index];
          const resultsDiv = document.getElementById('analysisResults');

          const title = document.createElement('h3');
          let parts = endpoint.split('/');
          let endpointKey = parts.slice(-2).join('/');
          let titleText = endpointTitles[endpointKey] || "Unknown";
          title.innerText = titleText;
          resultsDiv.appendChild(title);

          const uploadButton = document.createElement('img');
          uploadButton.src = 'img/share_whatsapp.png';
          uploadButton.width = 50
          uploadButton.alt = 'Clique para compartilhar pelo whatsapp';
          uploadButton.style.cursor = 'pointer';

          const spinner = document.createElement('img');
          spinner.src = "img/loading_01.gif"; // Make sure the 'img/loading.gif' exists
          spinner.alt = "Carregando...";
          spinner.style.display = 'none'; // Initially hidden
          spinner.id = 'spinner' + (index + 1); // Unique ID for each spinner
          spinner.width = 50; // Set the size of the spinner as needed

          if (endpoint === "/whatsapp/message/topic_modeling") {
              const placeholderImg = document.createElement('img');
              placeholderImg.src = "img/loading.gif";
              placeholderImg.width = 100;
              resultsDiv.appendChild(placeholderImg);

              fetchData(endpoint, formData)
              .then(htmlContent => {
                  const iframeContainer = document.createElement('div');
                  iframeContainer.style.display = 'flex';
                  iframeContainer.style.justifyContent = 'center';
                  iframeContainer.style.alignItems = 'center';
                  iframeContainer.style.height = '900px';  // Set to the desired height
                  iframeContainer.style.width = '1200px';

                  const iframe = document.createElement('iframe');
                  // iframe.width = "90%";  // Adjust width as needed
                  iframe.height = "100%";  // Use 100% to occupy the full height of the container

                  iframeContainer.appendChild(iframe);
                  resultsDiv.appendChild(iframeContainer);
                  iframe.width = "100%";  // or any other percentage or fixed value that looks better

                  iframe.contentWindow.document.open();
                  iframe.contentWindow.document.write(htmlContent);
                  iframe.contentWindow.document.close();
                  
                  // Remove or hide the placeholder image after the content is loaded
                  resultsDiv.removeChild(placeholderImg);

                  iframe.onload = () => iframe.scrollIntoView({ behavior: 'smooth' }); 

                  processEndpoint(index + 1, formData);  // Process the next endpoint
              })
              .catch(error => {
                  console.error('Error fetching the content:', error);
                  const errorDiv = document.createElement('div');
                  errorDiv.innerHTML = "<p>Error loading content</p>";
                  resultsDiv.appendChild(errorDiv);

                  resultsDiv.removeChild(placeholderImg);

                  processEndpoint(index + 1, formData);  // Process the next endpoint
              });
          } else {
              const img = document.createElement('img');
              img.id = 'image' + (index + 1);
              img.alt = title.innerText;
              img.width = 100;
              img.src = "img/loading.gif";
              resultsDiv.appendChild(img);

              fetchData(endpoint, formData)
              .then(imageBlob => {
                  const imageUrl = URL.createObjectURL(imageBlob);
                  img.width = 1200;
                  img.src = imageUrl;
                  img.onload = () => img.scrollIntoView({ behavior: 'smooth' });

                  uploadButton.onclick = () => uploadToImgur((index + 1));
                  resultsDiv.insertBefore(uploadButton, img.nextSibling);
                  resultsDiv.insertBefore(spinner, uploadButton.nextSibling);

                  processEndpoint(index + 1, formData);  // Process the next endpoint
              })
              .catch(error => {
                  console.error('Error fetching the image:', error);
                  img.width = 100;
                  img.src = "img/error.gif";

                  processEndpoint(index + 1, formData);  // Process the next endpoint
              });
          }
      }

      function submitForm() {
          var formData = new FormData(document.getElementById('uploadForm'));
          const resultsDiv = document.getElementById('analysisResults');
          resultsDiv.innerHTML = "";  // Clear previous results

          trackEvent('submit', 'Form', 'Chat Upload', 1);
          gtag('submit', 'Form', {'send_to': 'AW-11398970229/w499CJ7ZufMYEPX2ubsq'});
          gtag('event', 'conversion', {'send_to': 'AW-11398970229/xvhrCJKA4fMYEPX2ubsq'})

          processEndpoint(0, formData);  // Start processing from the first endpoint

          return false;  // Prevent actual form submission
      }
  </script>
  <a href="https://github.com/fcavalcantirj/analise-grupal-html" style="position: absolute; top: 0; right: 0; z-index: 100;">
    <img decoding="async" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_orange_ff7600.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" loading="lazy" data-recalc-dims="1">
  </a>
    <footer>
    <p>&copy; 2023 Analise Grupal. Todos os direitos reservados.</p>
  </footer>
</body>

</html>
